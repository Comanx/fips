<!DOCTYPE html>





<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  
    
    Code Generation
  
 | Fips Docs</title>



<link rel="stylesheet" href="/fips/book.min.bff781db5420417a98b39d5c502a421476ceee7df3af700be24e8554146bfa51.css">


<link rel="icon" href="/fips/favicon.png" type="image/x-icon">


<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body>
  <input type="checkbox" style="display: none" id="menu-control" />
  <main class="flex container">

    <aside class="book-menu fixed">
      <nav role="navigation">
<h2 class="book-brand">
  <a href="http://floooh.github.com/fips/">Fips Docs</a>
</h2>



    

  
  





 
  
    

  <ul>
    
    
    <li>
      

  <a href="/fips/docs/getstarted/" >
    
  
    
    Get Started
  

  </a>


    </li>
    
    <li>
      

  <a href="/fips/docs/build/" >
    
  
    
    Build Projects
  

  </a>


    </li>
    
    <li>
      

  <a href="/fips/docs/troubleshooting/" >
    
  
    
    Troubleshooting
  

  </a>


    </li>
    
    <li>
      

  <a href="/fips/docs/crosscompiling/" >
    
  
    
    Cross-compiling
  

  </a>


    </li>
    
    <li>
      

  <a href="/fips/docs/cmakeguide/" >
    
  
    
    CMake Guide
  

  </a>


    </li>
    
    <li>
      

  <a href="/fips/docs/imports/" >
    
  
    
    Imports
  

  </a>


    </li>
    
    <li>
      

  <a href="/fips/docs/exports/" >
    
  
    
    Exports
  

  </a>


    </li>
    
    <li>
      

  <a href="/fips/docs/codegen/"  class="active">
    
  
    
    Code Generation
  

  </a>


    </li>
    
    <li>
      

  <a href="/fips/docs/dirstructure/" >
    
  
    
    Directory Structure
  

  </a>


    </li>
    
  </ul>


  











</nav>


  
<script>
(function() {
  var menu = document.querySelector('aside.book-menu nav')
  addEventListener('beforeunload', function(event) {
    localStorage.setItem('menu.scrollTop', menu.scrollTop)
  });
  menu.scrollTop = localStorage.getItem('menu.scrollTop')
})()
</script>



    </aside>

    <div class="book-page">
      <header class="align-center justify-between book-header">
  <label for="menu-control">
    <img src="/fips/svg/menu.svg" alt="Menu" />
  </label>
  <strong>
  
    
    Code Generation
  
</strong>
</header>

      
<article class="markdown"><h1 id="code-generation">Code Generation</h1>
<p>Fips makes it easy to generate C/C++ source code by running Python scripts
during the build process. Special care has been taken to make code generation flexible so
that it is useful for many different scenarios. For instance here are
a few examples how the Oryol 3D engine uses code generation:</p>
<ul>
<li>generate code for serializable message protocols (similar to <a href="https://code.google.com/p/protobuf/">Google protobuf</a>)</li>
<li>embed image files into header files and generate a sprite sheet library</li>
<li>GLSL shader editing with IDE error integration (see <a href="http://flohofwoe.blogspot.de/2014/05/shader-compilation-and-ides.html">this blog post</a> and <a href="http://www.youtube.com/watch?v=Up9LFP5DMvw">video</a>)</li>
</ul>
<h3 id="using-code-generation">Using Code Generation</h3>
<p>The <strong>fips_generate</strong> cmake macro is used to tell fips how to generate C/C++ source code:</p>
<div class="highlight"><pre class="chroma"><code class="language-cmake" data-lang="cmake"><span class="nb">fips_generate</span><span class="p">(</span><span class="s">FROM</span> <span class="s">input_file</span>
              <span class="s">[TYPE</span> <span class="s">generator_type]</span>
              <span class="s">[SRC_EXT</span> <span class="s">source_file_extension]</span>
              <span class="s">[HDR_EXT</span> <span class="s">header_file_extension]</span>
              <span class="s">[SOURCE</span> <span class="s">out_source_file]</span>
              <span class="s">[HEADER</span> <span class="s">out_header_file]</span>
              <span class="s">[ARGS</span> <span class="s">args_as_yaml_string]</span><span class="p">)</span><span class="err">
</span></code></pre></div><p>Where:</p>
<ul>
<li><strong>FROM</strong>: Defines an input data file which is handed to the Python generator script
as argument, the input file can be anything, for instance JSON, YAML, XML or GLSL. It is
up to the generator script to make sense of the input file.</li>
<li><strong>TYPE</strong>: Defines the generator that should be used for code generation, this resolves
to a Python module which is imported and run at build time</li>
<li><strong>SOURCE</strong>: The filename of the generated source code file</li>
<li><strong>HEADER</strong>: The filename of the generated header code file</li>
<li><strong>SRC_EXT</strong>: Optional file extension for the generated source file (default is &ldquo;.cc&rdquo;)</li>
<li><strong>HDR_EXT</strong>: Optional file extension for the generated header file (default is &ldquo;.h&rdquo;)</li>
<li><strong>ARGS</strong>: An optional YAML formatted string defining additional arguments to the python
generator script.</li>
</ul>
<blockquote>
<p>NOTE that SRC_EXT and HDR_EXT are ignored if SOURCE and/or HEADER is also defined</p>
</blockquote>
<p>Let&rsquo;s go through a few examples:</p>
<p>The most usual form to call fips_generate() is to provide only a FROM and TYPE
argument:</p>
<div class="highlight"><pre class="chroma"><code class="language-cmake" data-lang="cmake"><span class="nb">fips_generate</span><span class="p">(</span><span class="s">FROM</span> <span class="s">IOProtocol.yml</span> <span class="s">TYPE</span> <span class="s">MessageProtocol</span><span class="p">)</span><span class="err">
</span></code></pre></div><p>This means that the input file <em>IOProtocol.yml</em> is converted by the generator
<em>MessageProtocol</em> into the output files <em>IOProtocol.cc</em> and <em>IOProtocol.h</em>.</p>
<p>If both the <em>SOURCE</em> and <em>HEADER</em> args are <strong>not</strong> provided, fips will
automatically generate one <em>.cc</em> source and one <em>.h</em> header file with the same base
name as the <em>FROM</em> file.</p>
<p>To generate output files with different file extensions, provide <em>SRC_EXT</em>
and/or <em>HDR_EXT</em>:</p>
<div class="highlight"><pre class="chroma"><code class="language-cmake" data-lang="cmake"><span class="nb">fips_generate</span><span class="p">(</span><span class="s">FROM</span> <span class="s">IOProtocol.yml</span> <span class="s">TYPE</span> <span class="s">MessageProtocol</span> <span class="s">SRC_EXT</span> <span class="s2">&#34;.cpp&#34;</span> <span class="s">HDR_EXT</span> <span class="s2">&#34;.hpp&#34;</span><span class="p">)</span><span class="err">
</span></code></pre></div><p>To generate output files with different filenames, provide them explicitly with
the <em>SOURCE</em> and <em>HEADER</em> args, in this case <em>SRC_EXT</em> and <em>HDR_EXT</em> are
ignored:</p>
<div class="highlight"><pre class="chroma"><code class="language-cmake" data-lang="cmake"><span class="nb">fips_generate</span><span class="p">(</span><span class="s">FROM</span> <span class="s">IOProtocol.yml</span>
              <span class="s">TYPE</span> <span class="s">MessageProtocol</span>
              <span class="s">SOURCE</span> <span class="s">IOProtocol_Generated.cpp</span>
              <span class="s">HEADER</span> <span class="s">IOProtocol_Generated.hpp</span><span class="p">)</span><span class="err">
</span></code></pre></div><p>Providing only <strong>one</strong> of <em>SOURCE</em> or <em>HEADER</em> means that the generator
should only generate either a source file or a header file, but not both.
This only works if the generator script knows that it should only write
one source or one header file.</p>
<p>The following example generates only a source file, but no header:</p>
<div class="highlight"><pre class="chroma"><code class="language-cmake" data-lang="cmake"><span class="nb">fips_generate</span><span class="p">(</span><span class="s">FROM</span> <span class="s">MyFile.xml</span> <span class="s">TYPE</span> <span class="s">MySourceGenerator</span> <span class="s">SOURCE</span> <span class="s">MyFile.cc</span><span class="p">)</span><span class="err">
</span></code></pre></div><p>Likewise, this example only generates a header, but no source:</p>
<div class="highlight"><pre class="chroma"><code class="language-cmake" data-lang="cmake"><span class="nb">fips_generate</span><span class="p">(</span><span class="s">FROM</span> <span class="s">MyFile.xml</span> <span class="s">TYPE</span> <span class="s">MyHeaderGenerator</span> <span class="s">HEADER</span> <span class="s">MyFile.h</span><span class="p">)</span><span class="err">
</span></code></pre></div><p>If the <em>TYPE</em> argument is omitted, the <em>FROM</em> argument must be
a Python file in the project source tree which is directly called to
create the output source files:</p>
<div class="highlight"><pre class="chroma"><code class="language-cmake" data-lang="cmake"><span class="nb">fips_generate</span><span class="p">(</span><span class="s">FROM</span> <span class="s">spritesheet.py</span><span class="p">)</span><span class="err">
</span></code></pre></div><p>In this case, the Python script <em>spritesheet.py</em> in the current
source code location will be called to generate the files
<em>spritesheet.cc</em> and <em>spritesheet.h</em>.</p>
<p>It is possible to provide additional arguments to the generator script
in a YAML-formatted string:</p>
<div class="highlight"><pre class="chroma"><code class="language-cmake" data-lang="cmake"><span class="nb">fips_generate</span><span class="p">(</span><span class="s">FROM</span> <span class="s">fs_metaballs.sc</span>
              <span class="s">TYPE</span> <span class="s">BgfxShaderEmbedded</span>
              <span class="s">HEADER</span> <span class="s">fs_metaballs.bin.h</span>
              <span class="s">ARGS</span> <span class="s2">&#34;{ type: fs, bla: blub }&#34;</span><span class="p">)</span><span class="err">
</span></code></pre></div><h3 id="writing-generators">Writing Generators</h3>
<p>A <em>generator</em> is a Python script which is called to generate C/C++ files.</p>
<p>Fips doesn&rsquo;t come with its own generators, instead it looks in the
<strong>fips-files/generators</strong> directory in the current project and imported projects
for generator scripts.</p>
<p>Let&rsquo;s check what generators Oryol has to offer:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt; cd oryol/fips-files/generators
&gt; ls *.py
MessageProtocol.py Shader.py          SoundSheet.py      SpriteSheet.py
</code></pre></div><p>A generator script must contain a Python function called &lsquo;generate()&rsquo;,
which can have the following forms (with or without args):</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># this is called if fips_generate() didn&#39;t have an ARGS argument:</span>
<span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">out_src</span><span class="p">,</span> <span class="n">out_hdr</span><span class="p">)</span> <span class="p">:</span>
    <span class="o">...</span>

<span class="c1"># this is called if fips_generate() was called with ARGS:</span>
<span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">out_src</span><span class="p">,</span> <span class="n">out_hdr</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="p">:</span>
    <span class="o">...</span>
</code></pre></div><p>Where:</p>
<ul>
<li><strong>input</strong>: is the absolute path to the input file (provided with the <em>FROM</em> cmake
argument of fips_generate())</li>
<li><strong>out_src</strong>: is the absolute path to the output source file, or None (provided with the
<em>SOURCE</em> cmake argument to fips_generate())</li>
<li><strong>out_hdr</strong>: is the absolute path to the output header file, or None (provided with the
<em>HEADER</em> cmake argument to fips_generate())</li>
<li><strong>args</strong>: if present, this is a dictionary of key/value pairs defined in the
<em>ARGS</em> cmake argument to fips_generate()</li>
</ul>
<h3 id="target-platform-detection">Target Platform Detection</h3>
<p>Sometimes you&rsquo;ll need to do things differently when cross-compiling to
specific target platforms. Use the <em>getutil.getEnv()</em> method with the
key <em>target_platform</em> to check the target platform, for instance to check
for iOS:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">genutil</span>

<span class="k">def</span> <span class="nf">only_on_ios</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">genutil</span><span class="o">.</span><span class="n">getEnv</span><span class="p">(</span><span class="s1">&#39;target_platform&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;ios&#39;</span><span class="p">:</span>
        <span class="c1"># building for iOS...</span>
</code></pre></div><p>The valid target platform names are the same as in the cmake variable
<em>FIPS_PLATFORM_NAME</em>:</p>
<ul>
<li>ios</li>
<li>osx</li>
<li>android</li>
<li>linux</li>
<li>linuxraspbian</li>
<li>win64</li>
<li>win32</li>
</ul>
<h3 id="file-dirty-check">File Dirty Check</h3>
<p>Generator scripts should not overwrite the target files if nothing has changed
in the source file, otherwise they would trigger unnecessary recompiles higher
up the source code dependency chain.</p>
<p>fips provides a simple helper function to perform 2 types of dirty checks:</p>
<ul>
<li>check the file modification timestamps of input files against the
modification timestamps of the generated source code files</li>
<li>check a <em>generator version</em> embedded in the first few lines of generated
files</li>
</ul>
<p>The second <em>generator version</em> check seems unusual, but this is very useful
when the generator scripts themselves are updated. For every change in
a generator script that influences the generated source code, the generator&rsquo;s
version number should be incremented. On the next build, all files generated
by this generator script will be written because the generator version
number doesn&rsquo;t match.</p>
<p>Let&rsquo;s have a look at a very simple generator script:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="s2">&#34;&#34;&#34;fips imported code generator for testing&#34;&#34;&#34;</span>

<span class="n">Version</span> <span class="o">=</span> <span class="mi">2</span>

<span class="kn">import</span> <span class="nn">genutil</span> <span class="kn">as</span> <span class="nn">util</span>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">generateHeader</span><span class="p">(</span><span class="n">hdrPath</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">hdrPath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span> <span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&#34;// #version:{}#</span><span class="se">\n</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Version</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&#34;extern void test_func(void);</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">generateSource</span><span class="p">(</span><span class="n">srcPath</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">srcPath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span> <span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&#34;// #version:{}#</span><span class="se">\n</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Version</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&#34;#include &lt;stdio.h&gt;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&#34;void test_func() {{</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;    printf(&#34;Hello from test_func!</span><span class="se">\\</span><span class="s1">n&#34;);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">out_src</span><span class="p">,</span> <span class="n">out_hdr</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">if</span> <span class="n">util</span><span class="o">.</span><span class="n">isDirty</span><span class="p">(</span><span class="n">Version</span><span class="p">,</span> <span class="p">[</span><span class="nb">input</span><span class="p">],</span> <span class="p">[</span><span class="n">out_src</span><span class="p">,</span> <span class="n">out_hdr</span><span class="p">])</span> <span class="p">:</span>
        <span class="n">generateHeader</span><span class="p">(</span><span class="n">out_hdr</span><span class="p">)</span>
        <span class="n">generateSource</span><span class="p">(</span><span class="n">out_src</span><span class="p">)</span>
</code></pre></div><p>Note the <strong>Version = 2</strong> statement in line 3, this is the &lsquo;generator version&rsquo;,
bumping this number will mark all generated source files as dirty and cause
all generated files to be overwritten regardless of their file modification time stamp.</p>
<p>The generator entry point is the <strong>generate()</strong> function in line 23, the first
line of this function checks whether the generator needs to run, first by checking
the version stamp, then by checking the file modification times of the input
file(s) and output files.</p>
<p>Header and source file are then written by the <strong>generateHeader()</strong> and
<strong>generateSource()</strong> functions.</p>
<p>Note that both functions write a magic version tag inside a C comment in the first
line which looks like <strong>#version:2#</strong>. The <strong>isDirty()</strong> helper function will
look in the first 4 text lines for this magic tag.</p>
<blockquote>
<p>NOTE: it is possible to provide &lsquo;None&rsquo; as version argument to genutil.isDirty(),
in this case, no version check will be performed</p>
</blockquote>
<p>The generated source files will look like this, first the header:</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="c1">// #version:2#
</span><span class="c1"></span><span class="k">extern</span> <span class="kt">void</span> <span class="nf">test_func</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</code></pre></div><p>&hellip;and the source file:</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="c1">// #version:2#
</span><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="kt">void</span> <span class="nf">test_func</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Hello from test_func!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>The generator in this example doesn&rsquo;t actually use an input file since
it generates the target files without any parameterization. This very special
case only works with a Python script in the source tree which serves as
&lsquo;input file&rsquo; and calls the above generator &lsquo;hello_generator&rsquo;:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">hello_generator</span> <span class="kn">as</span> <span class="nn">gen</span>

<span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">out_src</span><span class="p">,</span> <span class="n">out_hdr</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">gen</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">out_src</span><span class="p">,</span> <span class="n">out_hdr</span><span class="p">)</span>
</code></pre></div><p>The final missing piece is the CMakeLists.txt entry:</p>
<div class="highlight"><pre class="chroma"><code class="language-cmake" data-lang="cmake"><span class="nb">fips_begin_module</span><span class="p">(</span><span class="s">dep2</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="nb">fips_generate</span><span class="p">(</span><span class="s">FROM</span> <span class="s">hello.py</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">fips_end_module</span><span class="p">()</span><span class="err">
</span></code></pre></div><h3 id="under-the-hood">Under the hood</h3>
<p>This is what happens under the hood for code generation:</p>
<p><strong>in &lsquo;./fips gen&rsquo;</strong>:</p>
<p>A python file &lsquo;.fips-gen.py&rsquo; is created in the project root directory.
This sets up the python module search path to all imported projects so that
imported code-generator scripts can be found, and will be called during
the build process to load and invoke the code generator scripts.</p>
<p><strong>in fips_generate()</strong>:</p>
<ul>
<li>absolute filesystem paths for the FROM, SOURCE and HEADER files are derived</li>
<li>generate empty SOURCE and HEADER files in the same directory as the FROM
file, if they don&rsquo;t exist yet (this is a cmake requirement, all source code
files added to a build target must exist)</li>
<li>add the FROM, SOURCE and HEADER files to the current build target&rsquo;s file list</li>
<li>a YAML file will be populated with the information from all fips_generate()
calls at ${CMAKE_BINARY_DIR}/fips_codegen.yml (which is at
./fips-build/[proj-name]/[config-name]/fips_codegen.yml)</li>
<li>set a global flag that the current project has code generation</li>
</ul>
<p><strong>in fips_end_xxx()</strong>:</p>
<ul>
<li>the global &lsquo;project has code generation&rsquo; flag is set, generate a cmake
custom target named <em>ALL_GENERATE</em> which calls the generated &lsquo;.fips-gen.py&rsquo; script
with the also generated fips_codegen.yml file as argument</li>
<li>add the ALL_GENERATE custom build target as dependency to all build targets
with code generation</li>
</ul>
<p><strong>during builds</strong>:</p>
<ul>
<li>ALL_GENERATE custom build target will run before any regular build target
which depends on generated code</li>
<li>the ALL_GENERATE target runs the python file &lsquo;.fips-gen.py&rsquo; from the
project root directory with the fips_codegen.yml file as argument</li>
<li>&lsquo;.fips-gen.py&rsquo; loads the fips_codegen.yml file, and imports and runs
code generator python scripts, which will generate the C/C++ source code files
as needed</li>
</ul>
</article>

      

      
    </div>

    
  
  
  <aside class="book-toc fixed">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#using-code-generation">Using Code Generation</a></li>
        <li><a href="#writing-generators">Writing Generators</a></li>
        <li><a href="#target-platform-detection">Target Platform Detection</a></li>
        <li><a href="#file-dirty-check">File Dirty Check</a></li>
        <li><a href="#under-the-hood">Under the hood</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </aside>



  </main>
  
  
  
</body>

</html>
